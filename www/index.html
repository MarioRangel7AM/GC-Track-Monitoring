<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <link rel="stylesheet" type="text/css" href="css/gctrack.css" />
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <title>GCTrack</title>
</head>
<body>
    <div class="container-fluid">
        <img id="logologin" class="img-responsive" src="images/login_logo.png">
    </div>
    <div id="logincont"  class="container loginform">
        <div class="row">
            <div class="col-md-2 col-xs-2">
                <img class="img-user" src="images/login_user.png">
            </div>
            <div class="col-md-10 col-xs-10" style="padding-left:10%">
                <input id="inemail" name="mail" type="email" class="logininput" placeholder="Username" value="">
            </div>
        </div>
        <div class="row" style="margin-top:20px;">
            <div class="col-md-2 col-xs-2">
                <img class="img-user" src="images/login_pass.png">
            </div>
            <div class="col-md-10 col-xs-10" style="padding-left:10%">
                <input id="inpass" name="password" type="password" class="logininput" placeholder="Password" value="">
            </div>
        </div>
        <div class="logcont" style="margin-top:25px;">
            <input type="button" id="dologin" class="loginbutton" value="Enter">
        </div>
        <div class="logcont" style="margin-top:25px;">
            <input type="button" id="dohelp" class="loginbutton" value="About">
        </div>
      

   </div> 
    <div id="offlinediag" style="display:none;">
        <h2>No connection...</h2>
    </div>
    
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script type="text/javascript">
   var pushNotification;
            
            function onDeviceReady() {
                $("#app-status-ul").append('<li>deviceready event received</li>');
                
                document.addEventListener("backbutton", function(e)
                {
                    $("#app-status-ul").append('<li>backbutton event received</li>');
                    
                    if( $("#home").length > 0)
                    {
                        // call this to get a new token each time. don't call it to reuse existing token.
                        //pushNotification.unregister(successHandler, errorHandler);
                        e.preventDefault();
                        navigator.app.exitApp();
                    }
                    else
                    {
                        navigator.app.backHistory();
                    }
                }, false);
            
                try 
                { 
                    pushNotification = window.plugins.pushNotification;
                    if (device.platform == 'android' || device.platform == 'Android' ||
                            device.platform == 'amazon-fireos' ) {
            pushNotification.register(successHandler, errorHandler, {"senderID":"661780372179","ecb":"onNotification"});        // required!
                    } else {
                        pushNotification.register(tokenHandler, errorHandler, {"badge":"true","sound":"true","alert":"true","ecb":"onNotificationAPN"});    // required!
                    }
                }
                catch(err) 
                { 
                    txt="There was an error on this page.\n\n"; 
                    txt+="Error description: " + err.message + "\n\n"; 
                    alert(txt); 
                } 
            }
            
            // handle APNS notifications for iOS
            function onNotificationAPN(e) {
                if (e.alert) {
                     // showing an alert also requires the org.apache.cordova.dialogs plugin
                     navigator.notification.alert(e.alert);
                }
                    
                if (e.sound) {
                    // playing a sound also requires the org.apache.cordova.media plugin
                    var snd = new Media(e.sound);
                    snd.play();
                }
                
                if (e.badge) {
                    pushNotification.setApplicationIconBadgeNumber(successHandler, e.badge);
                }
            }
            
            // handle GCM notifications for Android
            function onNotification(e) {
                $("#app-status-ul").append('<li>EVENT -> RECEIVED:' + e.event + '</li>');
                
                switch( e.event )
                {
                    case 'registered':
                    if ( e.regid.length > 0 )
                    {
                        // Your GCM push server needs to know the regID before it can push to this device
                        // here is where you might want to send it the regID for later use.
                        console.log("regID = " + e.regid);
                    }
                    break;
                    
                    case 'message':
                        // if this flag is set, this notification happened while we were in the foreground.
                        // you might want to play a sound to get the user's attention, throw up a dialog, etc.
                        if (e.foreground)
                        {
                              
                                // on Android soundname is outside the payload. 
                                    // On Amazon FireOS all custom attributes are contained within payload
                                    var soundfile = e.soundname || e.payload.sound;
                                    // if the notification contains a soundname, play it.
                                    // playing a sound also requires the org.apache.cordova.media plugin
                                    var my_media = new Media("/android_asset/www/"+ soundfile);
                            my_media.play();
                        }
                        else
                        {   // otherwise we were launched because the user touched a notification in the notification tray.
                            if (e.coldstart)
                            else
                        }
                            
                                         break;
                    
                    case 'error':
                    break;
                    
                    default:
                    break;
                }
            }
            
            function tokenHandler (result) {
                $("#app-status-ul").append('<li>token: '+ result +'</li>');
               alert("token"+result);

               window.localStorage.setItem("token",result);
                

                  }
            
            function successHandler (result) {
                $("#app-status-ul").append('<li>success:'+ result +'</li>');
            }
            
            function errorHandler (error) {
                $("#app-status-ul").append('<li>error:'+ error +'</li>');
            }
            
            document.addEventListener('deviceready', onDeviceReady, true);
  










    $('#dologin').click(function(){
            inemail = $('#inemail').val();
            inpass = $('#inpass').val();
            $.post( "http://gct-dev.mybluemix.net/auth.php", { email: inemail, pass: inpass })
             .done(function( data ) {
                var data=$.parseJSON(data);
				console.log(data);
                if(data.resp=='Correcto'){
 window.localStorage.setItem("iduser", data.iduser);  
window.localStorage.setItem("sucess","true"); 
var token=window.localStorage.getItem("token");
  $.post( "http://gct-dev.mybluemix.net/registerToken.php", {TokenValue:token, userId:data.iduser})
             .done(function( data ) {
          


          });



				   location.href='dashboard.html';
                   navigator.notification.alert("GC-Track will monitor your system on the background. Please, do not force this app to terminate or completely close it.", null, "Reminder", "OK");
                }else{
	navigator.notification.alert("Please check you email address and password", null, "Error", "OK");//metodo para crear alertas personalizadas

                }
             });
        });
        
		
		
		$('#dohelp').click(function(){
 		location.href='help.html';
		
		});
		$( document ).ready(function() {
            
            $.post( "http://gct-dev.mybluemix.net/auth.php", { loging: "Show" })
             .done(function( data ) {
               var data=$.parseJSON(data);
			   if(window.localStorage.getItem("sucess")=="true"){
                    location.href='dashboard.html';
                }else{
                   $('#logincont').fadeIn();
                }
             });
        });
	
    
	
	</script>
</body>
</html>
