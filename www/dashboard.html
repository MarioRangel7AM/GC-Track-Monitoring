<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, target-densitydpi=medium-dpi, user-scalable=0" />
    <link rel="stylesheet" type="text/css" href="css/gctrack.css" />
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <title>GC Track</title>
</head>
<body>
    <div id="floattopheader">
        <div class="container-fluid">
            <img id="logologin" class="img-responsive" src="images/dash_logo.png">
            <hr width=100% align="center" class="division">
        </div> 
        <div id="demo">
            <div id="owl-demo" class="owl-carousel" style="display: none">
                <div class="item" id="refreshPage"><img src="img/iconorefreshgctrack55x55.png" style="margin-top:-15px;"class="img-cintillo"></div><!--Refresh-->
                <div class="item" id="contact"><img src="img/iconosupportgctrack55x55-2.png" style="margin-top:-15px;" class="img-cintillo"></div><!--Support-->
                <div class="item" id="sendReport"><img src="img/iconosendinfogctrack55x55.png" style="margin-top:-15px;" class="img-cintillo"></div><!--send report-->
                <div class="item" id="infoTracker"><img src="img/info55x55.png" style="margin-top:-15px;" class="img-cintillo"></div><!--info-->
                <div class="item" id="goback"><img src="img/iconogoback55x55.png" style="margin-top:-15px;" class="img-cintillo"></div><!--go back-->
                <div class="item" id="logout"><img src="img/iconologout55x55.png" style="margin-top:-15px;" class="img-cintillo"></div><!--logout-->
                <div class="item" ><a href="miPerfil.html"><img src="img/iconomiperfil55x55.png" style="margin-top:-15px;" class="img-cintillo"></a></div><!--myprofile-->
            </div>
        </div> 
    </div>
    <div id="fixedcontainer">
        <div id="view_tracker_status" style="display:none;">
            <div id="tracker_location">
                <div onclick="viewLocations()" class="locationmark" rel="2">
                    <h1 id="loc_business"></h1>
                    <p id="loc_pos"></p>
                </div>
            </div>
            <div id="list_trackers">
                <div class="row" ><div class="locationmark"><h2>Cargando...</h2></div></div>
            </div> 
            <div id="pumpstatuscont">
                <div id="listmoretracks" style="display:none;">
                </div>
                <div class="container dashmarg">
                    <div class="row">
                        <div class="col-md-3 col-xs-3">
                            <img id="pumptypeicon" class="iconlist"  src="images/icono-pumpressure.png">
                        </div>
                        <div class="col-md-9 col-xs-9">
                            <div class="row statsbg statsText">
                                <span id="pumptypename">type</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container dashmarg">
                    <div class="row">
                        <div class="col-md-3 col-xs-3">
                            <img class="iconlist"  src="images/icono-pumpressure.png">
                        </div>
                        <div class="col-md-9 col-xs-9">
                            <div class="row statsbg statsText">
                                Pump Pressure<br>
                                <span id="presiondata">0</span> PSI
                            </div>
                        </div>
                    </div>
                </div>
                <div id="statusnormal" style="display:none" class="container dashmarg">
                    <div class="row">
                        <div class="col-md-3 col-xs-3">
                            <img  id="pumpstatusicon" class="iconlist" src="images/dash_status.png">
                        </div>
                        <div class="col-md-9 col-xs-9">
                            <div id="pumpstatus" class="row statsbg statsText">
                                Pump Status<br>
                                <span id="pump_status">Normal</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="statuserror" style="display:none" class="container dashmarg">
                    <div class="row">
                        <div class="col-md-3 col-xs-3">
                            <img class="iconlist" id="img_status_res" src="images/dash_status.png">
                        </div>
                        <div class="col-md-9 col-xs-9">
                            <div id="" class="row statserror statsText" onClick="dismissBadge()">
                                Pump Status<br>
                                <span id="pump_status_res">Error</span><!--LOS IDS SON UNICOS NO PONGAS OTRAS COSAS O HABRA ERRORES-->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="showlog" class="container dashmarg">
                    <div class="row">
                        <div class="col-md-3 col-xs-3">
                            <img class="iconlist" id="statimage" src="images/dash_stadistics.png">
                        </div>
                        <div class="col-md-9 col-xs-9">
                            <div class="row statsbg" style="height:34px;">
                                <p id="dashstats">Data Logged</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="datalogged" style="display:none;">
        <table class="table" id="tblogheader">  
            <thead id="tbheader">
                <tr>
                    <td id="dHeader">Date</td>
                    <td id="sHeader">Pump status</td>
                    <td id="pHeader">PSI</td>
                </tr>
            </thead>
        </table>
        <table class="table" id="tblog">  
            <tbody>
            </tbody>
        </table>
    </div>
    <div id="offlinediag" style="display:none;">
        <h2>No connection...</h2>
    </div>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Owl Carousel Assets -->
    <link href="owl-carousel/owl.carousel.css" rel="stylesheet">
    <link href="owl-carousel/owl.theme.css" rel="stylesheet">
    <script src="owl-carousel/owl.carousel.js"></script>
<!-- 
<script src="js/jquery.fixedheadertable.js"></script>
<script src="js/demo.js"></script> 
-->
<script type="text/javascript" charset="utf-8">
//variables globales de la aplicacion
var screenpos = 'dashboard';
var isNotified = 0;
var generalres = 0;
var userid = 1;
var locaciones = [];
var listDevices = [];
var device = [];
var onscreen = 'dashboard';
var ontracker = 0;
var currentlocation="";
var tableOffset = 0;
var trackers_location = [];
var currentPumpstatus='';
var numale = 0;//numero de alertas de las alarmas de la bomba, las cuales se muestran como burbuja en el icono de la app
var currentIdUser=0;
var bombas_location  = [];
var myMedia=null;
document.addEventListener("deviceready", onDeviceReady, false);
// tenemos que guardar en la APP las locaciones
// guaramos las bombas por locacion
// actualizamos el estado de las bombas
// probamos las alertas de las bombas
// mostremos historial
// metodos que se cargan al iniciar la aplicacion
function onDeviceReady() {
    // Empty
    //console.log(navigator.notification);
    //console.log(navigator.vibrate);
    cordova.plugins.notification.badge.set(0);//burbuja de notificaion para ios
    cordova.plugins.backgroundMode.enable();//activa el modo de segundo plano
    cordova.plugins.backgroundMode.configure({
        title: 'GCTrack',
        text: 'Currently monitoring',
        ticker: 'reading'
    });
    myMedia = new Media("/android_asset/www/alarm.mp3", onSuccess,onError,onStatus);
}
// cuando cargue la APP aplicamos estos codigos
$( document ).ready(function() {
    userid = window.localStorage.getItem("iduser");
    bandera=0;//variable bandera para mostrar/ocultar los divs de informacion de la bomba
    var output="";
    var media;
    //OCULTAMOS EL ICONO INFO TRACKER
    $('#infoTracker').fadeOut();
    // cargamos bombas
    getPumps();
    // mostramos bombas
    showPumps();
    // desaparecemos elementos
    $('#goback').fadeOut();
    $('#sendReport').fadeOut();
    //boton para regresar al dash
    $('.godash').click(function(){
        onscreen = 'dashboard';
        $('#view_tracker_status').fadeOut();
        $('#list_trackers').fadeIn();
    });
    //boton para ir a ver perfil de usuario
    $('#myprofile').click(function(){
        window.localStorage.setItem("iduser",currentIdUser);
        location.href="miPerfil.html";
    });
    //cargamos el cintillo
    /*Eliminen estos si ya no lo ocupan*/
    var owl = $("#owl-demo");
    owl.owlCarousel({
        items : 6, //10 items above 1000px browser width
        itemsTablet: [600,6], //2 items between 600 and 0
        itemsMobile : false,// itemsMobile disabled - inherit from itemsTablet option
        touchDrag               : false,
        mouseDrag               : false
    });
    // al ver el tipo de bomba?
    $('#pumptypeicon').click(function(){
    // revisamos cuantas bombas hay y si tiene mas de 2 mostramos el submenu de seleccion
    // veamos las bombas activas
    var bactivas = 0;
    if(trackers_location[0].Bombas['b1']>0){
        bactivas++;
    }
    if(trackers_location[0].Bombas['b2']>0){
        bactivas++;
    }
    if(trackers_location[0].Bombas['b3']>0){
        bactivas++;
    }
    //console.log("CANTIDAD DE TRACKERS "+ trackers_location.length);
    if(bactivas>1){
        $('#listmoretracks').html('');
        if(trackers_location[0].Bombas['b1']>0){
            if(trackers_location[0].Bombas['b1']==2){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(2)" href="#"><img src="images/red-bombaelectrica.png"> B1 - Electric Pump</a></div>');
            }
            if(trackers_location[0].Bombas['b1']==1){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(1)" href="#"><img src="images/iconobombadiesel2.png"> B1 - Diesel Pump</a></div>');
            }
            if(trackers_location[0].Bombas['b1']==3){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(3)" href="#"><img src="images/red-bombajockey.png"> B1 - Jockey Pump</a></div>');
            }
        }
        if(trackers_location[0].Bombas['b2']>0){
            if(trackers_location[0].Bombas['b2']==2){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(2)" href="#"><img src="images/red-bombaelectrica.png"> B2 - Electric Pump</a></div>');
            }
            if(trackers_location[0].Bombas['b2']==1){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(1)" href="#"><img src="images/iconobombadiesel2.png"> B2 - Diesel Pump</a></div>');
            }
            if(trackers_location[0].Bombas['b2']==3){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(3)" href="#"><img src="images/red-bombajockey.png"> B2 - Jockey Pump</a></div>');
            }
        }
        if(trackers_location[0].Bombas['b3']>0){
            if(trackers_location[0].Bombas['b3']==2){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(2)" href="#"><img src="images/red-bombaelectrica.png"> B3 - Electric Pump</a></div>');
            }
            if(trackers_location[0].Bombas['b3']==1){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(1)" href="#"><img src="images/iconobombadiesel2.png"> B3 - Diesel Pump</a></div>');
            }
            if(trackers_location[0].Bombas['b3']==3){
                $('#listmoretracks').append('<div class="imoretracks"><a onClick="changeBomba(3)" href="#"><img src="images/red-bombajockey.png"> B3 - Jockey Pump</a></div>');
            }
        }
        $('#listmoretracks').fadeIn();
    }
    });
    $('#logout').click(function(){
//cuadro de dialogo para confirmar alguna accion
        navigator.notification.confirm(
    "If you logout, you won't receive any further alarms and notifications", // message
     onConfirm,            // callback to invoke with index of button pressed
    "WARNING",           // title
    ["OK","Cancel"]     // buttonLabels
);


       
    });



    function onConfirm(buttonIndex) {
if(buttonIndex==1){//the ok button
 $.getJSON( "http://gctrack-betaalterno.mybluemix.net/session_close.php?jsoncallback=?",{loging: "Show", id_user:currentIdUser})
        .done(function( data ) {
        //console.log(data); 
        //console.log("Mensaje"+data.mensaje);
        if(data.mensaje=='goodbye'){
            //console.log("ADENTRO DEL IF");
         cordova.plugins.backgroundMode.disable();//desactiva el modo de segundo plano
        window.localStorage.removeItem("sucess");
       // logoutAndClose();
        




        cordova.plugins.notification.badge.set(0);
    numale=0;
        
        location.href='index.html';
        }
        });

}
else{

//no hagas nada
    }

}
    // mostrando status de tracker
    $('#list_trackers').fadeOut();
    $('#view_tracker_status').fadeIn();
    $('#tracker_location').fadeIn();
    $('#list_trackers').fadeOut();
    viewLocations();
    $('.dashmarg').fadeOut();
    // para mostrar el log
    $('#showlog').click(function(){
    // Para hacer responsiva la posición de la tabla
    // con respecto al botón. Jorge Parra.
    var botonesTrackers = document.getElementsByClassName('locationmark');
    var botonTrackerActivo = botonesTrackers[0];
    var relleno = $(botonTrackerActivo).height();
    $('#datalogged').css("padding-top",relleno);
    $('#owl-demo').css('margin-left','0%');
    $('#goback').fadeIn();
    $('#sendReport').fadeIn();
    $('#gotoweb').fadeOut();
    $.post( "http://gctrack-betaalterno.mybluemix.net/getlog.php", {id_tracker: ontracker})
    .done(function( data ) {
        registros = [];
    //console.log(data);
    var json_obj = $.parseJSON(data);
    // reseteamos tabla
    $('#tblog > tbody').html('');
    /*$('#tblog > tbody').append('<thead class="header" ><tr><th>Date</th><th>Pump status</th><th>Pump Pressure</th></tr></thead><tbody>');*/
    if(json_obj.numresult>0){
        for (var i in json_obj.logs) {
            registro = {ID : json_obj.logs[i].ID, hora : json_obj.logs[i].hora ,Estado : json_obj.logs[i].ID, message:json_obj.logs[i].message, error_id:json_obj.logs[i].error_id, Presion: json_obj.logs[i].presion};
            registros.push(registro);
            $('#tblog > tbody').append('<tr><td style="width:22%;">'+json_obj.logs[i].hora+'</td><td style="width:41%;">'+json_obj.logs[i].message+'</td><td style="width:8%;">'+json_obj.logs[i].Presion+'</td></tr>');
        }
    }else{
    // No hay para mostrar
        alert('No incident logs');
    }
    //console.log(registros);
    $('#pumpstatuscont').fadeOut();
    $('#datalogged').fadeIn();
    $('#logout').fadeOut();
    $('#goback').fadeIn();
    });
    });//din del log
    //para regresar
    $('#goback').click(function(){
        location.href="dashboard.html";
    });
    //Para refrescar la pantalla
    $('#refreshPage').click(function(){
        location.reload(true);
    });
    // para contacto
    $('#contact').click(function(){
        window.localStorage.setItem("idTrackerToContactSupport", ontracker);
        location.href='contacto.html';
    });
    //revision de scroll - esto es para el datatable del historial de alarmas
    $(window).bind("scroll", function() {
        var tableOffset = $("#tblog").offset().top;
        var offset = $(this).scrollTop();
        var w1 = $('#tbheader td:nth-child(1)').width()+20;
        var w2 = $('#tbheader td:nth-child(2)').width()+20;
        var w3 = $('#tbheader td:nth-child(3)').width()+20;
        var h1 = $('#tbheader td:nth-child(1)').height()+20;
        $('#tbheaderfixed div:nth-child(1)').css('width',w1);
        $('#tbheaderfixed div:nth-child(2)').css('width',w2);
        $('#tbheaderfixed div:nth-child(3)').css('width',w3);
        $('#tbheaderfixed div:nth-child(2)').css('height',h1);
        $('#tbheaderfixed div:nth-child(3)').css('height',h1);
        if (offset >= tableOffset) {
            $('#tbheader').css('visibility', 'visible');
            $('#tbheaderfixed').css('visibility', 'visible');
        }else{
            $('#tbheader').css('visibility', 'visible');
            $('#tbheaderfixed').css('visibility', 'hidden');
        }
    });
    var setpadd = $('#floattopheader').height();
    $('#fixedcontainer').css('padding-top',setpadd );
    // fin de codigo de Scroll
    // que no se supone que traia la informacion de tracker? segun Carlos dijo que si
    $('#infoTracker').click(function(){
        var text="IDtracker:  "+ontracker+"\n"+"Brand: Firetrol"+"\n"+"Model: XFFD322";
        navigator.notification.alert(text, null, "Tracker Info", "OK");//metodo para crear alertas personalizadas
    });
});// fin del onready
// obtiene todas las bombas por usuario
function getPumps(){
    $('#infoTracker').fadeIn();
    //console.log('ID DE USUARIO '+userid);
    currentIdUser=userid;
    $.post( "http://gctrack-betaalterno.mybluemix.net/getpumps.php", {id_user: userid})
        .done(function( data ) {
        locaciones = [];
        //console.log('deget'+data);
        var json_obj = $.parseJSON(data);
        if(json_obj.numresult>0){
        for (var i in json_obj.locations) 
        {
            locacion = {ID : json_obj.locations[i].ID,business : json_obj.name_business ,loc_name : json_obj.locations[i].Nombre};
            locaciones.push(locacion);
        }
        }else{
        // No hay para mostrar
        navigator.notification.alert("No pumps and places for this account", null, "Warning", "OK");
        }
        //console.log(locaciones);
        showPumps();
    });
}
// mostramos las bombas
function showPumps(){
    output = "";
    for (var i in locaciones) {
    // imprimimos aqui es donde al darle click se despliega la informacion de los trackers
        output+='<div class="row"><div onClick="viewTrackers('+locaciones[i].ID+')" class="locationmark" rel="'+locaciones[i].ID+'"><h1>'+locaciones[i].business+'</h1><p>'+locaciones[i].loc_name+'</p><div id="toggleTrackers_'+locaciones[i].ID+'"></div></div></div></div>';
        currentlocation= locaciones[i].business+" Address " +locaciones[i].loc_name;
        // guardamos
    }
    output+="";
    // guardamos en contenedor
    $('#list_trackers').html(output);
}
var bandera=0;
function viewLocations(){
    // Esta función se ejecuta en el segundo click y al inicio
    // Centramos los iconos aumentando el margen izquierdo 
    $('#owl-demo').css('margin-left','16%');
    $('#infoTracker').fadeOut();
    $('#tracker_location').fadeOut();
    $('#list_trackers').fadeIn();
    $("#showlog").css("display", "none");
    $("#datalogged").css("display", "none");
    $('#sendReport').fadeOut();
    // Esta línea es necesaria para poder ocultar correctamente el estado del tracker.
    $("#pumpstatuscont").css("display","none");
    // Esta Linea ajusta de nuevo el margen izquierdo para centrar los objetos
}
// para ver los trackers de una locacion
function viewTrackers (idlocation) {
////console.log(idtracker);
// obtenemos los tracker de esa locacion
//Ajustamos el margen izquierdo para centrar los objetos
$('#owl-demo').css('margin-left','8%'); 
$("#infoTracker").fadeIn();
trackers_location = [];
bombas_location  = [];
    $.post( "http://gctrack-betaalterno.mybluemix.net/gettrackerlocation.php", {id_location: idlocation})
        .done(function( data ) {
           // console.log('ViewTrackers:'+data);
            var json_obj = $.parseJSON(data);
            if(json_obj.numresult>0){
        // si hay para mostrar
        if(json_obj.numresult==1){
        trackers_location.push(json_obj.trackers[0]);//se debe guardar la bomba incluso si es solo una, esto fue la causa del error
        getTracker(json_obj.trackers[0].ID);
        }else{
            output='<ul class="listTrackers">';
            for (var i in json_obj.trackers) 
            {
                output+='<li><a class="btnTrack trackerdevice" onClick="getTracker('+json_obj.trackers[i].ID+')" href="#'+json_obj.trackers[i].ID+'">'+json_obj.trackers[i].ID + ' - ' + json_obj.trackers[i].Descripcion+ '</a></li>' ;
                trackers_location.push(json_obj.trackers[i]);              
            }
            output+="</ul>";
        //$('#toggleTrackers_'+idlocation).html(output);
        // mostramos el primer tracker
        getTracker(json_obj.trackers[0].ID);
        }
        }else{
        // No hay para mostrar
        navigator.notification.alert("No logs available", null, "Empty log", "OK");
        }
    });
}
// para lanzar vision de tracker individual
function getTracker(idTracker){
    // obtenemos la ultima lectura del tracker
    $('#pumpstatuscont').fadeIn();
    $('#datalogged').fadeOut();
    $('#logout').fadeIn();
    $('#goback').fadeOut();
    $('.dashmarg').fadeIn();
    $('#listmoretracks').fadeOut();
    onscreen = 'viewtracker';
    ontracker = idTracker;
    window.localStorage.setItem("trackerId",ontracker);
    //console.log('ID TRACKER  '+ontracker);
    // window.localStorage.setItem("lasttrack", ontracker); //esta puede ser la linea de codigo que este causando que se quede la informacion de la sesion anterior
    $.post( "http://gctrack-betaalterno.mybluemix.net/gettracker.php", {id_tracker: idTracker})
    .done(function( data ) {
        //console.log('gettracker:'+data);
        var json_obj = $.parseJSON(data);
        if(json_obj.numresult>0){
        // si hay y tenemos informacion
        $('#presiondata').html(json_obj.tracker.Presion);
        $('#trackdata_id').html(json_obj.tracker.ID);
        //cambiamos el tipo de bomba
        //console.log('iniciamos ciclo:');
        // intentaremos mostrar la primera bomba/ por lo general siempre existe
        if(trackers_location[0].Bombas['b1']!=0){
            if(trackers_location[0].Bombas['b1']==2){
                $('#pumptypeicon').attr('src','images/bombaelectrica.png');
                $('#pumptypename').html('Electric<br>Pump')
            }
            if(trackers_location[0].Bombas['b1']==1){
                $('#pumptypeicon').attr('src','img/iconobombadiesel55x55.png');
                $('#pumptypename').html('Diesel<br>Pump')
            }
            if(trackers_location[0].Bombas['b1']==3){
                $('#pumptypeicon').attr('src','images/bombajockey.png');
                $('#pumptypename').html('Jokey<br>Pump')
            }
        }
        if(json_obj.tracker.Estado==1){
            $('#pump_status_res').html(json_obj.tracker.message);
            $('#statusnormal').fadeOut("normal", function () {
                $('#statusnormal').css({display:"none"});
            });
            $('#statuserror').fadeOut("normal", function () {
                $('#statuserror').css({display:"block"});
            });
            currentPumpstatus = json_obj.tracker.message;
            window.localStorage.setItem("pumpstatus",currentPumpstatus);
        }
        else{
            $('#pump_status_res').html(json_obj.tracker.message);
            $('#statuserror').fadeOut("normal", function () {
                $('#statuserro').css({display:"none"});
            });
            $('#statusnormal').fadeOut("normal", function () {
                $('#statusnormal').css({display:"block"});
            });
        }
        //titulos y sub
        $('#loc_business').html(json_obj.tracker.loc_business);
        $('#loc_pos').html(json_obj.tracker.loc_pos);
        //Mostramos la información del tracker al darle click
        $('#list_trackers').fadeOut();
        $('#view_tracker_status').fadeIn();
        $('#tracker_location').fadeIn();
        $('#list_trackers').fadeOut();
        //Calculamos el tamaño del banner del tracker para darle el espacio a la información.
        var botonesTrackers = document.getElementsByClassName('locationmark');
        var botonTrackerActivo = botonesTrackers[0];
        var relleno = $(botonTrackerActivo).height();
        $('#pumpstatuscont').css("padding-top",relleno);
        }
        else{
            // No hay para mostrar
            navigator.notification.alert("No logs available", null, "Info", "OK");//metodo para crear alertas personalizadas
        }
    });
} // fin de getTracker
// metodo de chekeo de status de todas las bombas y almacenamos en arreglo

function checkPump(){
    
var data="";
    $.post( "http://gctrack-betaalterno.mybluemix.net/checkpump.php", {id_user: userid,notified:isNotified})
     .done(function( data ) {
        //console.log("DATA RECIBIDA DE LA BOMBA: "+data);
        listDevices = []; //limpiamos
        var json_obj = $.parseJSON(data);
        ////console.log(data);
        for (var i in json_obj.tracker) 
        {
            //guardaremos nuestros dispositivos para consulta de estado
            device = {
                ID : json_obj.tracker[i].ID, 
                pressure : json_obj.tracker[i].pressure ,
                loc_business : json_obj.tracker[i].loc_business ,
                loc_pos : json_obj.tracker[i].loc_pos ,
                status : json_obj.tracker[i].status, 
                message: json_obj.tracker[i].message, 
                error_id : json_obj.tracker[i].error_id
            }
            listDevices.push(device);
        }
        //revisamos que todo este bien
        var tam = listDevices.length;
        resultpump = 0;
        for(i=0;i<tam;i++){
            //alert(listDevices[i].status);
            if(listDevices[i].status!='0'){
                // encontramos un problema
                resultpump = 1;//esto se pone en 1 en el momento del error
                //revisamos si esta notificado de esto
                if(isNotified == 1){
                    //no hacemos accion
                 }else{
                    //le mandamos la alerta
                    
//aqui se vera si el usuario respondio a la alarma
console.log("ERROR ID"+listDevices[i].error_id);

if(listDevices[i].error_id=="5-5"&&window.localStorage.getItem("isPressureNotified")=="1"){//SI SE ENCUENTRA ESTO MANDARA UN  AVISO PERO NO SONAR LA ALARMA, YA QUE ES UN CAMBIO SUBITO DE PRESION

 navigator.notification.alert("Sudden Change in Pressure", null, "Warning", "OK");
window.localStorage.setItem("isPressureNotified","1");
}



else{          

console.log("ENTRE AL ELSE WEY");
           $.post( "http://gctrack-betaalterno.mybluemix.net/checkIfAlarmIsActive.php", {id_tracker: json_obj.tracker[i].ID, id_user : currentIdUser})
    .done(function( data ) {
        data=$.parseJSON(data);
       // console.log("DATA"+data.answer);
        if(data.answer=="YES"){    
       // console.log("hola");  
        window.localStorage.setItem("alarmactive","YES");
    }

     
     });

    //console.log("valor del"+i+"LocAL STORAGE"+window.localStorage.getItem("alarmactive"));




          
if(window.localStorage.getItem("alarmactive")=="YES"){
   // console.log("valor dsdfcdsfsd"+i+"LocAL STORAGE"+window.localStorage.getItem("alarmactive"));
    //console.log("ya entre");



showAlert("Bomba #"+listDevices[i].ID+" Problema: "+listDevices[i].message);//muestra la notificacion
                  //  navigator.vibrate(1600);
      

                // numale++;
numale=1; 
        isNotified=1;
        window.localStorage.setItem("alarmactive","NO");

   /// console.log("valor NUMALE"+numale);
}

}

}
    
 
                    
                
            }
            else{
                //parese que todo marcha bien
            }
            //actualizamos la vista del tracker que estoy viendo
            ////console.log("Comparamos - "+parseInt(listDevices[i].ID) +'#'+ parseInt(ontracker));
            if(parseInt(listDevices[i].ID) == parseInt(ontracker)){
                if(onscreen=='viewtracker'){
                    //actualizamos la vista
                    ////console.log("Estamos en vista");
                    //console.log("ID>>>"+listDevices[i].ID+"Valor:"+listDevices[i].status);
                    $('#presiondata').html(listDevices[i].pressure);
                    if(parseInt(listDevices[i].status)!=0){
                        $('#pump_status_res').html(listDevices[i].message);
                        //icono
                        $('#statusnormal').fadeOut();
                        $('#statuserror').fadeIn();
                    }else{
                        $('#statusnormal').fadeIn();
                        $('#statuserror').fadeOut();
                    }
                }
            }
          
            break; //rompe el for
       



        }// fin del for
        // seteamos numero de alertas
        if(numale>0){
            cordova.plugins.notification.badge.set(numale);
        }else{
            cordova.plugins.notification.badge.set(0);
        }
        //aqui vemos si le avisamos que ya esta todo correcto despues de tener registrado que hay problemas
        if(resultpump != generalres){
            if(resultpump==1 && generalres==0){
                //signfica que se encontro problemas y registramos el marcador global
                generalres = 1;
            }else{
                if(resultpump==0 && generalres==1){
                    //signfica que ya no se encontro problemas y volvemos a la normalidad
                    generalres = 0;
                    isNotified = 0;
                   // navigator.vibrate(500);
                    
                    showAlertWithoutSound("Systems ready");//callas las alarmas
window.localStorage.setItem("isPressureNotified","0");

                } 
            }
        } 
    });
} 
// metodo general para lanzar notificaciones
//enviar tabla por correo
$('#sendReport').click(function(){
    var tableElement=document.getElementById('tblog').outerHTML;//ESTO CONVIERTE EL HTML A UN STRING
    var email = prompt("Please introduce the recipent email for the report", "");//correo al que se enviara la tabla
    var isValidEmail=validateEmail(email);
    var CCemail = prompt("If you want to add a CC please write the email address, otherwise write cancel or leave the field blank", "");//correo al que se enviara la tabla
    var isValidCCEmail=validateCCEmail(CCemail); 
    if(isValidEmail&&isValidCCEmail){
        var pump="Tracker location="+currentlocation+" Brand: Firetrol, Model:XFFD322, Status"+currentPumpstatus;
        var today = new Date();
        var dd = today.getDate();
    var mm = today.getMonth()+1; //January is 0!
    var hours=today.getHours();
    var minutes=today.getMinutes();
    var yyyy = today.getFullYear();
    if(dd<10){
        dd='0'+dd
    } 
    if(mm<10){
        mm='0'+mm
    } 
    var today = dd+'/'+mm+'/'+yyyy+'Hour '+hours+":"+minutes;
    //console.log(tableElement);
    $.post( "http://gctrack-betaalterno.mybluemix.net/sendEmail.php",{tableString:tableElement,correo:email,pumpData:pump,fecha:today,cc:CCemail})
    .done(function( data ) {
        //console.log(data);
        navigator.notification.alert("You report has been send", null, "Send report", "OK");
        //var data = $.parseJSON(data);
    });
}
else{
    navigator.notification.alert("You report cannot be send, please check you email address", null, "Error", "OK");
}
});
// metodo para validar correo
function validateEmail(email) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;//expresion regular para validar email
    return re.test(email);
}
// otro metodo? elijan cual es el correo y borren el que no necesiten
function validateCCEmail(email) {
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if(re.test(email)||email=="cancel"||email==""){
        return true;
    }
    else{
        return false;
    }
}



function showAlert(alertar) {
   
playAudio();
   
    
    var now = new Date().getTime();
    //var sound = device.platform == 'Android' ? 'file://sounds/alarm.mp3' : 'file://sounds/alarm.caf';
    var _3_sec_from_now = new Date(now + 3 *1000);
    media = new Media("alarm.mp3" ,onSuccess, onError, onStatus);//esto se reproducira en ios se agregaron 3 callbacks
   media.play({ playAudioWhenScreenIsLocked : true });//ESTE ES EL QUE SUENA EN EL IPHONE



    
        cordova.plugins.notification.local.schedule({
        id:1,//NO PONGAS PUNTO Y COMA YA QUE CAUSA ERROR
        text: "EMERGENCY "+alertar,
        at: now,
        badge: 1,
        every:"minute"
        //sound:'file://alarm.mp3'      
    });

 }      



// onSuccess Callback
function onSuccess() {
}
// onError Callback 
function onError(error) {
}
// onStatus Callback 
function onStatus(status) {
    if( status==Media.MEDIA_STOPPED ) {
        media.play({ playAudioWhenScreenIsLocked : true });
        myMedia.play({ playAudioWhenScreenIsLocked : true });
    }
}
function showAlertWithoutSound(alertar) { 

    //este metodo se llama cuando el sistema vuelve a la normalidad
    cordova.plugins.notification.badge.set(0);
    numale=0;
    var now  = new Date().getTime();
    var _3_sec_from_now = new Date(now + 3*1000);
    cordova.plugins.notification.local.schedule({
        id:1,//NO PONGA S PUNTO Y COMA YA QUE CAUSA ERROR
        text: alertar,
        at: now,
    });
    cordova.plugins.notification.local.cancelAll(function() {//cancela todas las notificaciones de alarma
    //navigator.notification.alert("Systems ready and working" ,null, "Alarm", "OK");//metodo para crear alertas personalizadas
    }, this);


    media.pause();
    pauseAudio();

}  
// metodo para borrar los valores de la  de burbuja de notificacion
function dismissBadge(){

       
    
   // console.log("VALOR "+ontracker);  
    cordova.plugins.notification.badge.set(0);
    numale=0;
    $.post( "http://gctrack-betaalterno.mybluemix.net/dismissAlarm.php", {id_tracker: ontracker, id_user : currentIdUser})
    .done(function( data ) {///con este post la alarma se cambia a 0 en la tabla
    
     });
 
 cordova.plugins.notification.local.cancelAll(function() {//cancela todas las notificaciones de alarma
 
 }, this);
   
navigator.notification.alert("Alarms dismissed" ,null, "Alarm", "OK");//metodo para crear alertas personalizadas
    media.pause();//se debe usar pause en vez de stop ya que cuando se detecte que se paro el audio, este se volvera a iniciar
    pauseAudio();
 window.localStorage.setItem("alarmactive","NO");




}
function playAudio() {
    myMedia.play({ playAudioWhenScreenIsLocked : true });
}
function pauseAudio() {
    myMedia.pause();


}
// metodo de logout
/*function logoutAndClose(){
    cordova.plugins.notification.badge.set(0);
    numale=0;
    cordova.plugins.notification.local.cancelAll(function() {
    //cancela todas las notificaciones de alarma
    }, this);
    myMedia.pause();//detiene el sonido en android
    media.pause();
}*/
// Repetidor de codigo
var timerId = setInterval(function() {
    checkPump();
    var connectionStatus = false;
    connectionStatus = navigator.onLine ? 'online' : 'offline';
    if(connectionStatus=='online'){
        $('#offlinediag').fadeOut();
    }else{
        $('#offlinediag').fadeIn();
    }
}, 3000);
function changeBomba(viewBomba){
    //cambiaremos el estado del icono
    $('#listmoretracks').fadeOut();
    if(viewBomba==2){
        $('#pumptypeicon').attr('src','images/bombaelectrica.png');
        $('#pumptypename').html('Electric<br>Pump')
    }
    if(viewBomba==1){
        $('#pumptypeicon').attr('src','img/iconobombadiesel55x55.png');
        $('#pumptypename').html('Diesel<br>Pump')
    }
    if(viewBomba==3){
        $('#pumptypeicon').attr('src','images/bombajockey.png');
        $('#pumptypename').html('Jokey<br>Pump')
    }
    // cambiaremos el estado de la bomba
} 
</script>
</body>
</html>